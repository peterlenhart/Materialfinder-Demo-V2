<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Material Finder</title>

    <!-- SheetJS für Excel-Import -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <style>
        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: #f4f6fa;
            color: #222;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h1 {
            margin: 10px 0 20px;
            font-size: clamp(1.8rem, 3vw, 2.4rem);
            text-align: center;
        }

        .button-main,
        .button-secondary {
            border: none;
            border-radius: 8px;
            padding: 14px 20px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
        }

        .button-main {
            background: #0056b3;
            color: #fff;
            width: 100%;
            max-width: 420px;
            margin: 8px 0 16px;
        }

        .button-secondary {
            background: #e0e0e0;
            color: #333;
            width: 100%;
            max-width: 420px;
            margin-bottom: 8px;
        }

        .status {
            font-size: 0.95rem;
            color: #444;
            margin-bottom: 18px;
            text-align: center;
        }

        .material-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 16px;
        }

        .material-button {
            flex: 1 1 80px;
            max-width: 120px;
            text-align: center;
            padding: 10px 8px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            background: #4b4f57;
            color: #fff;
            font-weight: 600;
        }

        .material-button.active {
            background: #0056b3;
        }

        .form-row {
            display: flex;
            gap: 10px;
            width: 100%;
            max-width: 420px;
            margin-bottom: 14px;
        }

        .form-group {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        label {
            font-size: 0.9rem;
            font-weight: 600;
        }

        select {
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #ccc;
            font-size: 1rem;
            width: 100%;
            background: #fff;
        }

        .result-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 24px;
            width: 100%;
        }

        /* Blaues Quadrat – wichtiges Displayfeld */
        .result-square {
            background: #004d99; /* aus CMYK 100/50/0/40 */
            border-radius: 24px;
            padding: 18px 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            margin: 0 auto 8px;

            /* Größe: Quadrat, auf Tablet Querformat ca. 1/3 Breite und ~40% Höhe */
            width: min(70vw, 33vw, 40vh, 420px);
            aspect-ratio: 1 / 1;
        }

        /* Materialnummer (weißer Balken) */
        .material-code {
            background: #ffffff;
            color: #000000;
            border-radius: 14px;
            padding: 8px 16px;
            min-width: 60%;
            text-align: center;
            font-size: clamp(1.3rem, 2.5vw, 1.9rem);
            letter-spacing: 0.18em;
            font-weight: 600;
            margin-bottom: 12px;
        }

        /* große gelbe Lagerzahl im Quadrat */
        .location-number {
            color: #ffd500;
            font-weight: 800;
            font-size: clamp(3rem, 10vw, 6rem);
            line-height: 1;
            margin-top: auto;
            margin-bottom: auto;
        }

        /* Regal-Text direkt unterhalb des Quadrats */
        .shelf-text {
            margin-top: 6px;
            font-size: clamp(1.2rem, 2.3vw, 1.6rem);
            font-weight: 600;
            color: #222;
        }

        .hidden {
            display: none;
        }

        @media (min-width: 900px) and (orientation: landscape) {
            body {
                padding: 30px 40px;
            }

            .form-row {
                max-width: 480px;
            }
        }
    </style>
</head>

<body>
    <h1>Material Finder</h1>

    <!-- Excel Import -->
    <button class="button-secondary" id="importBtn">Excel importieren</button>
    <input type="file" id="fileInput" accept=".xlsx,.xls" style="display:none" />

    <div class="status" id="statusText">
        Keine Excel-Daten importiert (Demo-Fallback aktiv).
    </div>

    <!-- Material-Auswahl -->
    <div class="material-buttons" id="materialButtons">
        <button class="material-button active" data-mat="K110">K110</button>
        <button class="material-button" data-mat="Tlx">Tlx</button>
        <button class="material-button" data-mat="Toolox">Toolox</button>
        <button class="material-button" data-mat="W300">W300</button>
    </div>

    <!-- Höhe/Breite Dropdowns -->
    <div class="form-row">
        <div class="form-group">
            <label for="heightSelect">Höhe</label>
            <select id="heightSelect"></select>
        </div>
        <div class="form-group">
            <label for="widthSelect">Breite</label>
            <select id="widthSelect"></select>
        </div>
    </div>

    <!-- Suchen-Button -->
    <button class="button-main" id="searchBtn">Suchen</button>

    <!-- Ergebnis-Anzeige -->
    <div class="result-wrapper hidden" id="resultWrapper">
        <div class="result-square">
            <div class="material-code" id="materialCodeDisplay">0000</div>
            <div class="location-number" id="locationNumberDisplay">0</div>
        </div>
        <div class="shelf-text" id="shelfTextDisplay">Regal –</div>
    </div>

    <script>
        // Daten aus Excel
        let allRows = [];          // komplette Datensätze
        let filteredRows = [];     // Zeilen für gewählten Werkstoff (mit Höhe/Breite aufbereitet)

        // Fallback-Daten, falls keine Excel geladen (einfaches Beispiel)
        const demoData = [
            { Mat: "7900001014", Werkstoff: "K110", Maße: "50 x 70", Lag: "6.1" },
            { Mat: "7900001015", Werkstoff: "K110", Maße: "40 x 60", Lag: "5.1" },
            { Mat: "7900001020", Werkstoff: "Tlx", Maße: "30 x 50", Lag: "4.2" },
            { Mat: "7900001025", Werkstoff: "Toolox", Maße: "20 x 30", Lag: "2.1" },
            { Mat: "7900001030", Werkstoff: "W300", Maße: "50 x 70", Lag: "7.3" }
        ];

        allRows = demoData.slice(); // Standard: Demo aktiv

        const importBtn = document.getElementById('importBtn');
        const fileInput = document.getElementById('fileInput');
        const statusText = document.getElementById('statusText');

        const materialButtons = document.querySelectorAll('.material-button');
        const heightSelect = document.getElementById('heightSelect');
        const widthSelect = document.getElementById('widthSelect');
        const searchBtn = document.getElementById('searchBtn');

        const resultWrapper = document.getElementById('resultWrapper');
        const materialCodeDisplay = document.getElementById('materialCodeDisplay');
        const locationNumberDisplay = document.getElementById('locationNumberDisplay');
        const shelfTextDisplay = document.getElementById('shelfTextDisplay');

        // Excel-Datei auswählen
        importBtn.addEventListener('click', () => fileInput.click());

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (evt) => {
                const data = new Uint8Array(evt.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];

                const json = XLSX.utils.sheet_to_json(worksheet, { defval: "" });

                // Wir erwarten Spalten: Mat, Werkstoff, Maße, Lag
                allRows = json.map(row => ({
                    Mat: String(row.Mat || row.MAT || row.mat || ""),
                    Werkstoff: String(row.Werkstoff || row.Material || row.WERKSTOFF || ""),
                    Maße: String(row.Maße || row.Masse || row.Format || ""),
                    Lag: String(row.Lag || row.Lager || row.LAGER || "")
                })).filter(r => r.Mat && r.Werkstoff && r.Maße && r.Lag);

                statusText.textContent = `Excel-Daten importiert: ${allRows.length} Datensätze.`;
                buildDropdownsForCurrentMaterial();
            };
            reader.readAsArrayBuffer(file);
        });

        // Material-Buttons
        materialButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                materialButtons.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                buildDropdownsForCurrentMaterial();
            });
        });

        // Höhenauswahl ändert die möglichen Breiten
        heightSelect.addEventListener('change', updateWidthsForSelectedHeight);

        // Suche
        searchBtn.addEventListener('click', () => {
            const mat = getCurrentMaterial();
            const h = Number(heightSelect.value);
            const b = Number(widthSelect.value);

            if (!mat || !h || !b) {
                alert("Bitte Werkstoff, Höhe und Breite auswählen.");
                return;
            }

            // passenden Datensatz suchen
            const match = filteredRows.find(r =>
                r.Werkstoff === mat &&
                Number(r.H) === h &&
                Number(r.B) === b
            );

            if (!match) {
                alert("Kein passender Datensatz gefunden.");
                return;
            }

            // Materialnummer – nur die letzten 4 Stellen
            const fullMat = String(match.Mat || "");
            const shortMat = fullMat.slice(-4); // letzte 4 Ziffern
            materialCodeDisplay.textContent = shortMat || "----";

            // Lagerplatz / Regal
            const lag = String(match.Lag || "");
            const parts = lag.split(".");
            const lagerNummer = parts[0] || "";
            const regalNummer = parts[1] || "";

            locationNumberDisplay.textContent = lagerNummer || "-";
            shelfTextDisplay.textContent = regalNummer
                ? `Regal ${regalNummer}`
                : "Regal –";

            resultWrapper.classList.remove('hidden');
        });

        function getCurrentMaterial() {
            const active = document.querySelector('.material-button.active');
            return active ? active.dataset.mat : "";
        }

        // Baut Dropdowns für den aktuell gewählten Werkstoff
        function buildDropdownsForCurrentMaterial() {
            const mat = getCurrentMaterial();
            if (!mat) return;

            // Nur Zeilen für diesen Werkstoff
            const rowsForMat = allRows.filter(r => String(r.Werkstoff) === mat);

            // Höhe/Breite aus dem Maße-Feld holen (immer kleinere Zahl = Höhe)
            filteredRows = rowsForMat.map(r => {
                const nums = String(r.Maße)
                    .replace(/,/g, ".")
                    .match(/(\d+(\.\d+)?)/g) || [];

                let a = Number(nums[0] || 0);
                let b = Number(nums[1] || 0);

                if (!a || !b) return null;

                const H = Math.min(a, b);
                const B = Math.max(a, b);

                return {
                    Mat: String(r.Mat),
                    Werkstoff: String(r.Werkstoff),
                    H,
                    B,
                    Lag: String(r.Lag)
                };
            }).filter(Boolean);

            // eindeutige Höhen
            const uniqueHeights = [...new Set(filteredRows.map(r => r.H))].sort((x, y) => x - y);

            heightSelect.innerHTML = "";
            uniqueHeights.forEach(h => {
                const opt = document.createElement('option');
                opt.value = h;
                opt.textContent = h;
                heightSelect.appendChild(opt);
            });

            // passende Breiten zur ersten Höhe laden
            updateWidthsForSelectedHeight();
        }

        function updateWidthsForSelectedHeight() {
            const selectedH = Number(heightSelect.value);
            widthSelect.innerHTML = "";

            const widths = filteredRows
                .filter(r => Number(r.H) === selectedH)
                .map(r => r.B);

            const uniqueWidths = [...new Set(widths)].sort((x, y) => x - y);

            uniqueWidths.forEach(b => {
                const opt = document.createElement('option');
                opt.value = b;
                opt.textContent = b;
                widthSelect.appendChild(opt);
            });
        }

        // Initial: Dropdowns für Standard-Material (K110) aus Demo-Daten aufbauen
        buildDropdownsForCurrentMaterial();
    </script>
</body>
</html>
